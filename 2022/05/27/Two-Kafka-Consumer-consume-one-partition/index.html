<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>奇怪现象：两个Consumer消费同一个分区（Partition） - 执子之手</title>
    <meta name="keywords" content="Orchid,Orchidflower,程序员,架构师,个人,思考,读书,笔记,技术,分享,Golang">
    
    <meta property="og:title" content="奇怪现象：两个Consumer消费同一个分区（Partition）">
    <meta property="og:site_name" content="执子之手">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="奇怪现象：两个Consumer消费同一个分区（Partition） - 执子之手" />
    <meta name="description" content="Do one thing at a time, and do well."> 
    <link rel="shortcut icon" href="https://orchidflower.github.io/img/favicon.ico" />
    <link rel="apple-touch-icon" href="https://orchidflower.github.io/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="https://orchidflower.github.io/img/apple-touch-icon.png" />
    <link href="https://orchidflower.github.io/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="https://orchidflower.github.io/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="https://orchidflower.github.io/css/main.css" rel="stylesheet" type="text/css" />
    
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="https://orchidflower.github.io"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">执子之手</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">与子偕老</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="https://orchidflower.github.io/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://orchidflower.github.io/categories" rel="section">
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://orchidflower.github.io/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://orchidflower.github.io/tags/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://orchidflower.github.io/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="https://orchidflower.github.io/2022/05/27/Two-Kafka-Consumer-consume-one-partition/" itemprop="url">
        奇怪现象：两个Consumer消费同一个分区（Partition）
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2022-05-27">
    2022-05-27
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="https://orchidflower.github.io/categories/%E5%BC%80%E5%8F%91" itemprop="url" rel="index">
        <span itemprop="name">开发</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">3385 字 ~7分钟</span>
</span>
      <span id="/2022/05/27/Two-Kafka-Consumer-consume-one-partition/" class="leancloud_visitors" data-flag-title="奇怪现象：两个Consumer消费同一个分区（Partition）">
    &nbsp; | &nbsp;
    <span class="post-meta-item-icon">
        <i class="fa fa-fire"></i>
    </span>
    <span class="post-meta-item-text">访问：</span>
    <span class="leancloud-visitors-count">0</span>
</span>
      
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <p>最近生产上碰到一个奇怪的问题，现场人员反馈<code>Kafka</code>工作不正常。经过开发人员检查，发现一个奇怪的现象：线上两台服务器竟然在同时消费一个<code>Kafka</code> <code>Topic</code>中的一个分区（<code>Partition</code>）。</p>
<h1 id="1-背景">1. 背景</h1>
<p>我们的程序要实现的功能是这样的：系统会定时扫描库存表，根据库存情况决定是否要执行出库操作。之前是采用定时任务处理，执行策略是1分钟一次，为了防止多台服务器并发执行，使用<code>Quartz</code>集群模式确保定时任务只在一台服务器上执行。最近客户提出需求，某些时候客户希望响应更及时一些，譬如某项请求到达的时候，就要立即检查库存并决定是否需要出库。因此，开发人员对系统进行了调整，改为使用<code>Kafka</code> <code>Consumer</code>来触发扫描库存动作；定时任务和接口处同时负责发送触发库存扫描的消息。</p>
<p>相关的代码如下：</p>
<p><code>Consumer</code>用来处理扫描库存的功能：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">LibraryOutboundTriggerConsumer</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">final</span> <span style="color:#111">OutboundService</span> <span style="color:#111">outboundService</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">final</span> <span style="color:#111">BoxInfoService</span> <span style="color:#111">boxInfoService</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    <span style="color:#75af00">@KafkaListener</span><span style="color:#f92672">(</span><span style="color:#111">topics</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;${fwm.core.topic.library-outbound-trigger}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">consume</span><span style="color:#f92672">(</span><span style="color:#111">ConsumerRecord</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">,</span> <span style="color:#111">String</span><span style="color:#f92672">&gt;</span> <span style="color:#111">record</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>        <span style="color:#111">log</span><span style="color:#f92672">.</span><span style="color:#75af00">info</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;\n\n&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>        <span style="color:#111">log</span><span style="color:#f92672">.</span><span style="color:#75af00">info</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;=====================开始执行出库扫描=====================&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">boxInfoService</span><span style="color:#f92672">.</span><span style="color:#75af00">hasBoxUpdateTask</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>            <span style="color:#111">log</span><span style="color:#f92672">.</span><span style="color:#75af00">info</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;=====================存在料箱更新任务，执行出库扫描结束=====================&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>            <span style="color:#00a8c8">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>        <span style="color:#111">Stopwatch</span> <span style="color:#111">stopwatch</span> <span style="color:#f92672">=</span> <span style="color:#111">Stopwatch</span><span style="color:#f92672">.</span><span style="color:#75af00">createStarted</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>            <span style="color:#111">boxInfoService</span><span style="color:#f92672">.</span><span style="color:#75af00">startOutboundTask</span><span style="color:#f92672">(</span><span style="color:#111">90</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>            <span style="color:#111">outboundService</span><span style="color:#f92672">.</span><span style="color:#75af00">outboundTaskScan</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>        <span style="color:#f92672">}</span> <span style="color:#00a8c8">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>            <span style="color:#111">boxInfoService</span><span style="color:#f92672">.</span><span style="color:#75af00">stopOutboundTask</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>        <span style="color:#111">log</span><span style="color:#f92672">.</span><span style="color:#75af00">info</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;=====================执行出库扫描结束,总耗时{}ms=====================&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">stopwatch</span><span style="color:#f92672">.</span><span style="color:#75af00">elapsed</span><span style="color:#f92672">(</span><span style="color:#111">TimeUnit</span><span style="color:#f92672">.</span><span style="color:#75af00">MILLISECONDS</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>定时任务相关代码，用来发送触发扫描的<code>Kafka</code>消息：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">LibraryScanJob</span> <span style="color:#00a8c8">extends</span> <span style="color:#111">QuartzJobBean</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">final</span> <span style="color:#111">KafkaTemplate</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">,</span> <span style="color:#111">String</span><span style="color:#f92672">&gt;</span> <span style="color:#111">kafkaTemplate</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">final</span> <span style="color:#111">CoreProperties</span> <span style="color:#111">coreProperties</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>    <span style="color:#00a8c8">protected</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">executeInternal</span><span style="color:#f92672">(</span><span style="color:#111">JobExecutionContext</span> <span style="color:#111">jobExecutionContext</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">JobExecutionException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>        <span style="color:#111">kafkaTemplate</span><span style="color:#f92672">.</span><span style="color:#75af00">send</span><span style="color:#f92672">(</span><span style="color:#111">coreProperties</span><span style="color:#f92672">.</span><span style="color:#75af00">getTopic</span><span style="color:#f92672">().</span><span style="color:#75af00">getLibraryOutboundTrigger</span><span style="color:#f92672">(),</span> <span style="color:#d88200">&#34;1&#34;</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;Job Trigger&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9</span><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>我们服务端部署的情况是：应用部署在两台服务器上<code>server01</code>，<code>server02</code>；<code>Kafka</code>部署在三台服务器上<code>Kafka01</code>，<code>Kafka02</code>，<code>Kafka03</code>。<code>Consumer</code>负责消费<code>library-outbound-trigger</code>这个<code>Topic</code>，这个<code>Topic</code>虽然被创建为三个分区，但是实际使用中只用了一个分区，这是因为在发送消息的时候指定了<code>Key</code>值。我们知道，默认情况下<code>Kafka</code>会调用<code>Partitioner</code>对发送内容进行分区，默认的分区算法为<code>DefaultPartitioner</code>，简单来说其算法是：如果<code>Key</code>有值，则根据<code>key</code>计算一个Hash值，然后针对分区数取余；如果<code>Key</code>为空，则使用<code>Round-Robin</code>策略进行分区。</p>
<blockquote>
<p>DefaultPartitioner is a Partitioner that uses a 32-bit murmur2 hash to compute the partition for a record (with the key defined) or chooses a partition in a round-robin fashion (per the available partitions of the topic).</p>
</blockquote>
<blockquote>
<p>DefaultPartitioner is the default partitioning strategy (per ProducerConfig.PARTITIONER_CLASS_CONFIG configuration property).</p>
</blockquote>
<p>因为上述代码中我们指定了<code>Key</code>固定为<code>1</code>，所以它总会分配到同一个分区中，也就是虽然我们创建了三个分区，实际上应该只有一个分区有数据。通过工具软件查看<code>Kafka</code>中的数据也确实证明了这一点。</p>
<p>因为实际上只有一个分区有数据，所以<code>Consumer</code>应该只在一台服务器上才能够执行。但是经过观察日志发现，两台服务器上都能够看到<code>执行出库扫描</code>这种日志。</p>
<h1 id="2问题分析">2.问题分析</h1>
<p><code>Kafka</code>中一个<code>Partition</code>只能由一个<code>Consumer Group</code>中的一个<code>Consumer</code>消费，这是保证负载均衡的需要，也是<code>Kafka</code>实现消息相对有序性的一个核心设计理念。用过<code>Kafka</code>的人都应该见过这张图：
<img src="https://www.oreilly.com/library/view/kafka-the-definitive/9781491936153/assets/ktdg_04in05.png" alt=""></p>
<p>这张图描述了两个<code>Consumer Group</code>同时在消费一个<code>Topic</code>，不论哪个<code>Consumer Group</code>，对于一个特定的<code>Partition</code>来说，总是只有一个<code>Consumer</code>在消费其中的消息。对我们的系统来说，只有一个分区有数据，按理说应该只有一台服务器消费才正确。</p>
<p>我们在生产环境安装了<code>Kafka</code>管理工具<code>Kowl</code>，经过查看<code>Kafka</code>的运行状态，发现该<code>Topic</code>经常出现没有<code>Consumer</code>消费的情况，而且消费者也不固定；另外，该Topic出现了非常巨大的<code>Lag</code>，消费<code>Offset</code>始终没有更新。明显是<code>Kafka</code>触发<code>Rebalancing</code>导致的。但是因为服务端禁用了<code>Rebalance</code>相关的日志，所以从日志中没有找到相关证据，只能通过分析代码来确认问题。</p>
<p>注意上面<code>Consumer</code>中的代码，<code>Stopwatch</code>计时的范围并不包括对<code>hasBoxUpdateTask</code>的调用，该函数是用于防并发设置的，但是这个函数本身写的有问题，导致执行时间过长。而日志中看到的扫描时间并没有包含这个函数执行的时间，因此没有看出异常情况。<code>hasBoxUpdateTask</code>的代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">hasBoxUpdateTask</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>        <span style="color:#111">List</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">&gt;</span> <span style="color:#111">keys</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">ArrayList</span><span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>        <span style="color:#111">redisTemplate</span><span style="color:#f92672">.</span><span style="color:#75af00">execute</span><span style="color:#f92672">((</span><span style="color:#111">RedisConnection</span> <span style="color:#111">connection</span><span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>            <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">Cursor</span><span style="color:#f92672">&lt;</span><span style="color:#00a8c8">byte</span><span style="color:#f92672">[]&gt;</span> <span style="color:#111">cursor</span> <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">scan</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>                    <span style="color:#111">ScanOptions</span><span style="color:#f92672">.</span><span style="color:#75af00">scanOptions</span><span style="color:#f92672">().</span><span style="color:#75af00">count</span><span style="color:#f92672">(</span><span style="color:#111">10</span><span style="color:#f92672">).</span><span style="color:#75af00">match</span><span style="color:#f92672">(</span><span style="color:#111">BOX_UPDATE_TASK_PREFIX</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;*&#34;</span><span style="color:#f92672">).</span><span style="color:#75af00">build</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>                <span style="color:#111">cursor</span><span style="color:#f92672">.</span><span style="color:#75af00">forEachRemaining</span><span style="color:#f92672">(</span><span style="color:#111">value</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>                    <span style="color:#111">keys</span><span style="color:#f92672">.</span><span style="color:#75af00">add</span><span style="color:#f92672">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">String</span><span style="color:#f92672">(</span><span style="color:#111">value</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>                <span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>            <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">Exception</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>                <span style="color:#111">log</span><span style="color:#f92672">.</span><span style="color:#75af00">error</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;hasBoxUpdateTask&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">e</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">keys</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>        <span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">keys</span><span style="color:#f92672">.</span><span style="color:#75af00">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> <span style="color:#111">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>可以看到代码里面使用了<code>Redis</code>中生产环境不建议用的<code>Scan</code>指令。虽然<code>Scan</code>命令比<code>Keys *</code>要安全一些，但是同样有可能导致全库扫描：当全库键值很多，匹配数量又很少的时候，一次调用就会触发全库扫描，耗时会很长。经过实验，我们全库19w+，一次不匹配的扫描耗时大概15~20秒。</p>
<p>在<code>Spring</code>中，我们对于<code>Consumer</code>配置如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#f92672">spring</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>  <span style="color:#f92672">kafka</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    <span style="color:#f92672">consumer</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>      <span style="color:#f92672">enable-auto-commit</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>      <span style="color:#f92672">auto-commit-interval</span><span style="color:#111">:</span> <span style="color:#ae81ff">1000ms</span>
</span></span></code></pre></div><p>按照上面的配置，期望的表现是每秒钟提交一次<code>Offset</code>，那为什么会出现<code>Offset</code>始终没有更新的情况呢？</p>
<h1 id="3-原因解读">3. 原因解读</h1>
<p>以前一直知道<code>Kafka Consumer</code>如果处理时间过长就可能导致问题。这次正好查阅一下文档来明确问题产生的原因及问题的表现。</p>
<p>经过研究，发现之前对于自动提交还有些理解不准确的地方。首先，看一下<code>O'Reilly</code>经典的<code>Kafka: The Definitive Guide</code>中关于自动提交的描述（第4章）：</p>
<blockquote>
<p>Automatic Commit</p>
</blockquote>
<blockquote>
<p>The easiest way to commit offsets is to allow the consumer to do it for you. If you configure enable.auto.commit=true, then every five seconds the consumer will commit the largest offset your client received from poll(). The five-second interval is the default and is controlled by setting auto.commit.interval.ms. Just like everything else in the consumer, the automatic commits are driven by the poll loop. Whenever you poll, the consumer checks if it is time to commit, and if it is, it will commit the offsets it returned in the last poll.</p>
</blockquote>
<p><code>Kafka</code>的自动提交机制是依赖于<code>poll</code>循环机制的：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#00a8c8">while</span><span style="color:#f92672">(</span><span style="color:#00a8c8">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>    <span style="color:#75715e">// 每次调用poll的时候判断是否需要提交offset
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span><span style="color:#75715e"></span>    <span style="color:#111">ConsumerRecords</span> <span style="color:#111">records</span> <span style="color:#f92672">=</span> <span style="color:#111">consumer</span><span style="color:#f92672">.</span><span style="color:#75af00">poll</span><span style="color:#f92672">(</span><span style="color:#111">Duration</span><span style="color:#f92672">.</span><span style="color:#75af00">ofMillis</span><span style="color:#f92672">(</span><span style="color:#111">10000</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    <span style="color:#111">processRetrievedRecords</span><span style="color:#f92672">(</span><span style="color:#111">records</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>也就是说： <strong>Kafka只有在发生一次poll的时候才会将上次处理完的Offset提交上去。</strong> 如果消息处理时间过长，就会出现<code>Offset</code>没有来得及提交的情况。</p>
<p>而一次消费时间的长短又与<code>max.poll.records</code>有关：<code>Kafka</code>一次<code>poll</code>可以拉取最多<code>max.poll.records</code>条记录，然后缓存在本地进行处理。只有本地缓存的数据处理完毕，才会再次进行<code>poll</code>。而这个值默认为500。</p>
<blockquote>
<p>max.poll.records</p>
</blockquote>
<blockquote>
<p>The maximum number of records returned in a single call to poll(). Note, that
max.poll.records does not impact the underlying fetching behavior. The consumer
will cache the records from each fetch request and returns them incrementally
from each poll.</p>
</blockquote>
<blockquote>
<p>Type:	int Default:	500</p>
</blockquote>
<p>而判断处理时间是否超时则与<code>max.poll.interval.ms</code>有关：<code>max.poll.interval.ms</code>定义了两次<code>poll</code>之间的时间间隔。</p>
<blockquote>
<p>max.poll.interval.ms</p>
</blockquote>
<blockquote>
<p>The maximum delay between invocations of poll() when using consumer group management.
This places an upper bound on the amount of time that the consumer can be idle before
fetching more records. If poll() is not called before expiration of this timeout, then
the consumer is considered failed and the group will rebalance in order to reassign
the partitions to another member. For consumers using a non-null group.instance.id
which reach this timeout, partitions will not be immediately reassigned. Instead,
the consumer will stop sending heartbeats and partitions will be reassigned after
expiration of session.timeout.ms. This mirrors the behavior of a static consumer which
has shutdown.</p>
</blockquote>
<blockquote>
<p>Type:	int Default:	300000 (5 minutes)</p>
</blockquote>
<p>可以看到两次<code>poll</code>之间的最长时间为5分钟，如果超过5分钟，则会被判定为<code>Consumer LeaveGroup</code>，然后触发<code>Rebalancing</code>。</p>
<p>综合起来看，这个问题出现的原因应该是这样：</p>
<ul>
<li><code>Kafka</code>一次获取了大量的记录，例如500条；</li>
<li>每条记录消费大概占用15~20秒；</li>
<li>记录还没处理完，时间就超过了5分钟，引起了<code>Rebalancing</code>；</li>
<li><code>Rebalancing</code>之后，<code>Consumer</code>由另一台服务器接管，进入上面同样的处理；而此时第一台服务器上的消息还没有处理完毕，也在继续循环处理；</li>
<li>这样两台服务器都在处理数据，但是<code>Offset</code>却永远没有办法更新；看上去就像是两个<code>Consumer</code>在消费同一个<code>Partition</code>。</li>
</ul>
<h1 id="4-修改及总结">4. 修改及总结</h1>
<p>修改代码，不再使用<code>Redis</code>的<code>Scan</code>指令，提高处理速度，问题得以解决。</p>
<p>两点教训：</p>
<ol>
<li>在<code>Redis</code>生产环境中不能够使用类似<code>Keys</code>，<code>Scan</code>这种指令，这种指令很容易导致超长的处理时间；</li>
<li><code>Kafka</code>的自动提交机制依赖于<code>poll</code>循环，如果一次消息处理时间过长，就会出问题。最好的方法是提高处理速度；如果实在不行，可以降低每次拉取的记录数，修改<code>max.poll.records</code>参数。在<code>springboot</code>中可以通过<code>spring.kafka.consumer.max-poll-records</code>参数进行修改。</li>
</ol>
    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="https://orchidflower.github.io/tags/Kafka" rel="tag" title="Kafka">#Kafka#</a>
    
    <a href="https://orchidflower.github.io/tags/Redis" rel="tag" title="Redis">#Redis#</a>
    
    <a href="https://orchidflower.github.io/tags/Rebalancing" rel="tag" title="Rebalancing">#Rebalancing#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="https://orchidflower.github.io/2022/12/01/Expand-Linux-Partition-without-Data-Loss/" rel="next" title="无损扩容Linux磁盘分区容量">
        <i class="fa fa-chevron-left"></i> 无损扩容Linux磁盘分区容量
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="https://orchidflower.github.io/2022/03/02/Adding-Scrollbar-In-Flex-Layout/" rel="prev" title="Flex布局添加滚动条需要注意的规则">
        Flex布局添加滚动条需要注意的规则 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     



<div id="vcomments"></div>
    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

  <ul class="sidebar-nav motion-element">
    <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
      文章目录
    </li>
    <li class="sidebar-nav-overview" data-target="site-overview">
      站点概览
    </li>
  </ul>

    <section class="site-overview sidebar-panel ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="https://orchidflower.github.io/img/author.jpg"
        alt="Orchidflower" />
    <p class="site-author-name" itemprop="name">Orchidflower</p>
    <p class="site-description motion-element" itemprop="description"> 
        Do one thing at a time, and do well.</p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="https://orchidflower.github.io/post/">
        <span class="site-state-item-count">76</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="https://orchidflower.github.io/categories/">      
         
        <span class="site-state-item-count">6</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="https://orchidflower.github.io/tags/">
         
        <span class="site-state-item-count">83</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://orchidflower.github.io" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
        <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/orchid-flower" target="_blank" title="知乎">
            <i class="fa fa-fw fa-globe"></i>
            知乎
        </a>
        </span>
    
        <span class="links-of-author-item">
        <a href="https://orchidflower.gitee.io" target="_blank" title="OSC">
            <i class="fa fa-fw fa-git"></i>
            OSC
        </a>
        </span>
    
        <span class="links-of-author-item">
        <a href="https://www.douban.com/people/47742465/" target="_blank" title="豆瓣">
            <i class="fa fa-fw fa-globe"></i>
            豆瓣
        </a>
        </span>
    
</div>


      

      
    </section>
    
<section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
    <div class="post-toc">
        <div class="post-toc-content"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-背景">1. 背景</a></li>
    <li><a href="#2问题分析">2.问题分析</a></li>
    <li><a href="#3-原因解读">3. 原因解读</a></li>
    <li><a href="#4-修改及总结">4. 修改及总结</a></li>
  </ul>
</nav></div>
    </div>
</section>

  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">执子之手</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.104.3</a>
</div>
<div class="powered-by">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>
<div class="theme-info">
  ICP - <a href="https://beian.miit.gov.cn/" target="_blank">鲁ICP备17006463号-1</a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="https://orchidflower.github.io/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="https://orchidflower.github.io/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="https://orchidflower.github.io/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="https://orchidflower.github.io/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="https://orchidflower.github.io/js/utils.js"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/motion.js"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/affix.js"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/schemes/pisces.js"></script>

<script type="text/javascript" src="https://orchidflower.github.io/js/scrollspy.js"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/post-details.js"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/toc.js"></script>

<script type="text/javascript" src="https://orchidflower.github.io/js/bootstrap.js"></script>

<script type="text/javascript" src="https://orchidflower.github.io/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
<script src="https://orchidflower.github.io/js/vendor/valine/av-min.js"></script>
<script src="https://orchidflower.github.io/js/vendor/valine/Valine.min.js"></script>

<script>
  new Valine({
    el: '#vcomments',
    appId: 'rRoK18jJcvpFfn8Qmjmr0U5Y-MdYXbMMI',
    appKey: '0VSzBkok3Snp1c4xHL4r3Sn3',
    serverURLs: 'https:\/\/leancloud-api.orchidflower.cn',
    visitor: true,
    placeholder: 'Leave a comment...',
    recordIP: true
  })
</script>

</body>
</html>