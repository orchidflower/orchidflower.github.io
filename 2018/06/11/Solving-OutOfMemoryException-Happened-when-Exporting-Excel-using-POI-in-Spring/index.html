<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
    <title>Spring使用POI导出Excel内存溢出问题的解决 - 执子之手</title>
    <meta name="keywords" content="Orchid,Orchidflower,程序员,架构师,个人,思考,读书,笔记,技术,分享,Golang">
    
    <meta property="og:title" content="Spring使用POI导出Excel内存溢出问题的解决">
    <meta property="og:site_name" content="执子之手">
    <meta property="og:image" content="/img/author.jpg"> 
    <meta name="title" content="Spring使用POI导出Excel内存溢出问题的解决 - 执子之手" />
    <meta name="description" content="Do one thing at a time, and do well."> 
    <link rel="shortcut icon" href="https://orchidflower.github.io/img/favicon.ico" />
    <link rel="apple-touch-icon" href="https://orchidflower.github.io/img/apple-touch-icon.png" />
    <link rel="apple-touch-icon-precomposed" href="https://orchidflower.github.io/img/apple-touch-icon.png" />
    <link href="https://orchidflower.github.io/js/vendor/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />
    <link href="https://orchidflower.github.io/js/vendor/fancybox/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />
    <link href="https://orchidflower.github.io/css/main.css" rel="stylesheet" type="text/css" />
    
    <script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
     fancybox: true, 
    motion: true
  };
</script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<div class="container one-collumn sidebar-position-left page-home  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-meta  custom-logo ">

  <div class="custom-logo-site-title">
    <a href="https://orchidflower.github.io"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">执子之手</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">与子偕老</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
    <ul id="menu" class="menu">
      
      
        <li class="menu-item ">
          <a href="https://orchidflower.github.io/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://orchidflower.github.io/categories" rel="section">
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://orchidflower.github.io/post/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://orchidflower.github.io/tags/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签
          </a>
        </li>
      
        <li class="menu-item ">
          <a href="https://orchidflower.github.io/about/" rel="section">
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> 搜索</a>
      </li>
    </ul>
    <div class="site-search">
      <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>

    </div>
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="https://orchidflower.github.io/2018/06/11/Solving-OutOfMemoryException-Happened-when-Exporting-Excel-using-POI-in-Spring/" itemprop="url">
        Spring使用POI导出Excel内存溢出问题的解决
        </a>
      </h1>
      <div class="post-meta">
      <span class="post-time">
<span class="post-meta-item-icon">
    <i class="fa fa-calendar-o"></i>
</span>
<span class="post-meta-item-text">时间：</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2018-06-11">
    2018-06-11
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  <span class="post-meta-item-icon">
    <i class="fa fa-folder-o"></i>
  </span>
  <span class="post-meta-item-text">分类：</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="https://orchidflower.github.io/categories/%E5%BC%80%E5%8F%91" itemprop="url" rel="index">
        <span itemprop="name">开发</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
&nbsp; | &nbsp;
<span class="post-meta-item-icon">
    <i class="fa fa-eye"></i>
</span>
<span class="post-meta-item-text">阅读：</span>
<span class="leancloud-visitors-count">3063 字 ~7分钟</span>
</span>
      <span id="/2018/06/11/Solving-OutOfMemoryException-Happened-when-Exporting-Excel-using-POI-in-Spring/" class="leancloud_visitors" data-flag-title="Spring使用POI导出Excel内存溢出问题的解决">
    &nbsp; | &nbsp;
    <span class="post-meta-item-icon">
        <i class="fa fa-fire"></i>
    </span>
    <span class="post-meta-item-text">访问：</span>
    <span class="leancloud-visitors-count">0</span>
</span>
      
      </div>
    </header>
    <div class="post-body" itemprop="articleBody">
    <p>云认证平台提供将认证记录导出为Excel的功能。但是当业务量慢慢发展起来以后，就碰到一个比较棘手的问题：需要导出的认证记录太多，导出Excel的时候经常碰到服务器内存溢出问题。例如当要导出30w条记录的时候，服务端内存占用会超过2G，继续增加Heap空间不是一个非常合适的方案，因为无法预知一共需要多少内存。</p>
<p>因此，这两天特意找了一下解决方案，终于有了解决方案。最终方案导出256w条记录的时候，服务器内战占用1.6G，不再继续增加。</p>
<h1 id="1-poi项目简介">1. POI项目简介</h1>
<p>用Java导出Excel就无法绕过Apache POI项目。说起来，POI项目这个名字很有意思，它是“Poor Obfuscation Implementation”的缩写，翻译过来是“劣质的困惑的实现”。不过这个名字实际上已经被废弃掉了，只能在早期的文档中找到。这个名字起源于项目的早期，因为微软格式不开放，所以只能够通过反向工程猜测格式的含义，所以才有了这个幽默的称呼。到后来微软开放了OOXML规范，实际上格式已经是开源的标准了。另一个废弃的原因则是出于市场考虑（商业用户对这个名字可能会引起过多联想而不敢采用）。</p>
<p>有兴趣的可以到<a href="https://en.wikipedia.org/wiki/Apache_POI">https://en.wikipedia.org/wiki/Apache_POI</a>上了解一些历史。</p>
<p>POI项目提供了对Word、Excel、PowerPoint、Visio等文件的读写支持。提供了对Office 97到Office2007的格式支持。既支持OOXML标准的文档（.docx, .xlsx, .pptx），也支持旧格式（.doc, .xls, .ppt）。</p>
<h2 id="11-excel相关">1.1 Excel相关</h2>
<p>POI项目中包含多个子项目，分别对应不同格式文件的读写，不同的读写机制等等。与Excel相关的，主要有两个子项目：</p>
<ul>
<li>HSSF (Horrible SpreadSheet Format) 读写.xls文件。可以读写Excel 97及之后版本生成的文件。这个格式也被称为“BIFF 8 Format”。因为这个格式没有开源，因此有些特性没有被支持。</li>
<li>XSSF (XML SpreadSheet Format) 读写.xlsx格式。也就是Office Open XML格式。</li>
<li>SXSSF（Small XSSF）读写.xlsx格式。3.8-beta3新增，基于XSSF实现的一个低内存占用的API。这是一个基于流的API。通过限制API能够访问的记录行数来达到减少内存占用的目的。在这种API中，可以只有一部分行保存在内存中，其他的则保存在硬盘缓存中。所以会有一些限制，例如：不在内存中的行无法被访问；Sheet.clone()不被支持；Formula计算不被支持等。</li>
</ul>
<p>下面是一个表格，列出了各个API的一些特性。
<img src="http://poi.apache.org/resources/images/ss-features.png" alt=""></p>
<p>HSSF、XSSF都支持两种编程模型：eventmodel（类似于XML解析中的SAX，基于流的解析）；usermodel（类似于XML解析中的DOM模型）。</p>
<h1 id="2-excel导出">2. Excel导出</h1>
<p>实际项目中已经使用了SXSSF项目（但是依然会溢出，原因不在Excel这部分，原因下面分析）。这里依然简单的介绍一下怎么使用SXSSF导出一个Excel。下面是一个简单的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#75715e">// 创建一个Excel文件，在内存中保存100条记录，其余的会被flush到硬盘上
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#75715e"></span><span style="color:#111">Workbook</span> <span style="color:#111">workbook</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">SXSSFWorkbook</span><span style="color:#f92672">(</span><span style="color:#111">100</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#75715e">// 创建一个Sheet
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#75715e"></span><span style="color:#111">Sheet</span> <span style="color:#111">workingSheet</span> <span style="color:#f92672">=</span> <span style="color:#111">workbook</span><span style="color:#f92672">.</span><span style="color:#75af00">createSheet</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;sheet1&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="color:#75715e">// 创建第一行，用于显示每列标题
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#75715e"></span><span style="color:#111">Row</span> <span style="color:#111">row</span> <span style="color:#f92672">=</span> <span style="color:#111">workingSheet</span><span style="color:#f92672">.</span><span style="color:#75af00">createRow</span><span style="color:#f92672">(</span><span style="color:#111">0</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#75715e">// 创建单元格样式
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style="color:#75715e"></span><span style="color:#111">Font</span> <span style="color:#111">fontHeader</span> <span style="color:#f92672">=</span> <span style="color:#111">workbook</span><span style="color:#f92672">.</span><span style="color:#75af00">createFont</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#111">fontHeader</span><span style="color:#f92672">.</span><span style="color:#75af00">setFontHeightInPoints</span><span style="color:#f92672">((</span><span style="color:#00a8c8">short</span><span style="color:#f92672">)</span> <span style="color:#111">10</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#111">fontHeader</span><span style="color:#f92672">.</span><span style="color:#75af00">setColor</span><span style="color:#f92672">(</span><span style="color:#111">IndexedColors</span><span style="color:#f92672">.</span><span style="color:#75af00">BLACK</span><span style="color:#f92672">.</span><span style="color:#75af00">getIndex</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#111">fontHeader</span><span style="color:#f92672">.</span><span style="color:#75af00">setBoldweight</span><span style="color:#f92672">(</span><span style="color:#111">Font</span><span style="color:#f92672">.</span><span style="color:#75af00">BOLDWEIGHT_BOLD</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style="color:#111">CellStyle</span> <span style="color:#111">csHeader</span> <span style="color:#f92672">=</span> <span style="color:#111">workbook</span><span style="color:#f92672">.</span><span style="color:#75af00">createCellStyle</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style="color:#111">csHeader</span><span style="color:#f92672">.</span><span style="color:#75af00">setFont</span><span style="color:#f92672">(</span><span style="color:#111">fontHeader</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span><span style="color:#111">csHeader</span><span style="color:#f92672">.</span><span style="color:#75af00">setBorderLeft</span><span style="color:#f92672">(</span><span style="color:#111">CellStyle</span><span style="color:#f92672">.</span><span style="color:#75af00">BORDER_THIN</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span><span style="color:#111">csHeader</span><span style="color:#f92672">.</span><span style="color:#75af00">setBorderRight</span><span style="color:#f92672">(</span><span style="color:#111">CellStyle</span><span style="color:#f92672">.</span><span style="color:#75af00">BORDER_THIN</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span><span style="color:#111">csHeader</span><span style="color:#f92672">.</span><span style="color:#75af00">setBorderTop</span><span style="color:#f92672">(</span><span style="color:#111">CellStyle</span><span style="color:#f92672">.</span><span style="color:#75af00">BORDER_THIN</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span><span style="color:#111">csHeader</span><span style="color:#f92672">.</span><span style="color:#75af00">setBorderBottom</span><span style="color:#f92672">(</span><span style="color:#111">CellStyle</span><span style="color:#f92672">.</span><span style="color:#75af00">BORDER_THIN</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span><span style="color:#111">csHeader</span><span style="color:#f92672">.</span><span style="color:#75af00">setAlignment</span><span style="color:#f92672">(</span><span style="color:#111">CellStyle</span><span style="color:#f92672">.</span><span style="color:#75af00">ALIGN_CENTER</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span><span style="color:#75715e">// 手动设置列宽。第一个参数表示要为第几列设置，第二个参数表示列的宽度，n为列高的像素数。
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span><span style="color:#75715e"></span><span style="color:#111">workingSheet</span><span style="color:#f92672">.</span><span style="color:#75af00">setColumnWidth</span><span style="color:#f92672">(</span><span style="color:#111">0</span><span style="color:#f92672">,</span> <span style="color:#f92672">(</span><span style="color:#00a8c8">int</span><span style="color:#f92672">)(</span><span style="color:#111">35</span><span style="color:#f92672">.</span><span style="color:#75af00">7</span> <span style="color:#f92672">*</span> <span style="color:#111">150</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span><span style="color:#111">Cell</span> <span style="color:#111">cell</span> <span style="color:#f92672">=</span> <span style="color:#111">row</span><span style="color:#f92672">.</span><span style="color:#75af00">createCell</span><span style="color:#f92672">(</span><span style="color:#111">0</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span><span style="color:#111">cell</span><span style="color:#f92672">.</span><span style="color:#75af00">setCellValue</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;Title&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span><span style="color:#111">cell</span><span style="color:#f92672">.</span><span style="color:#75af00">setCellStyle</span><span style="color:#f92672">(</span><span style="color:#111">csHeader</span><span style="color:#f92672">);</span>
</span></span></code></pre></div><p>与使用XSSF的方法相比，唯一改变的就是创建Excel对象的地方：<code>Workbook workbook = new SXSSFWorkbook(100);</code>，SXSSF需要指定内存中可用的记录数，例如上面的例子中指定了100条记录。超出100条的记录将被写入磁盘，不能够直接访问。但是对于导出Excel这种场景来说，不会有随机访问数据的要求，这样的方式是没有影响的。</p>
<h1 id="3-使用数据库游标">3. 使用数据库游标</h1>
<p>因为以前已经在项目中使用了SXSSF项目，因此内存溢出问题应该不是POI项目带来的。经过调查，发现这是数据库方面的原因：</p>
<ol>
<li>如果不适用游标，MySQL默认会将结果集整个都缓存的客户端，对于几十万上百万条记录，这个内存占用是巨大的；</li>
<li>MyBatis返回结果集的时候是将JDBC的ResultSet转换成具体对象的List，在这个过程中，会将所有的数据库记录转换成Java对象，更加容易带来内存溢出的问题。</li>
</ol>
<p>在结果集比较小的情况下，将结果集整体返回，会带来性能上的优势。但是当结果集变大的时候，内存占用和性能上都会碰到极大的问题。以上两个问题，都需要启用游标来解决。</p>
<h2 id="31-数据库游标">3.1 数据库游标</h2>
<p>在数据库中，游标是一个十分重要的概念。游标提供了一种对从表中检索出的数据进行操作的灵活手段，就本质而言，游标实际上是一种能从包括多条数据记录的结果集中每次提取一条记录的机制。游标总是与一条SQL选择语句相关联。因为游标由结果集（可以是零条、一条或由相关的选择语句检索出的多条记录）和结果集中指向特定记录的游标位置组成。当决定对结果集进行处理时，必须声明一个指向该结果集的游标。</p>
<p>通过MyBatis使用游标，有几种方法：SpringBatch项目带来的<code>MyBatisCursorItemReader</code>；MyBatis本身的<code>SqlSession.selectCursor</code>方法；以及MyBatis提供的<code>ResultHandler</code>接口。这几种方法的不同下一篇博文会涉及到。这里只说一下如何使用Spring Batch提供的<code>MyBatisCursorItemReader</code>。</p>
<p><code>MyBatisCursorItemReader</code>是Spring Batch项目提供的一个Bean，提供了使用游标从数据库读取数据的功能。需要MyBatis 3.4.0或更新版本的支持。其本质还是对<code>SqlSession.selectCursor</code>的一个简单封装，有兴趣的可以看一下源码。</p>
<h2 id="32-引入支持包">3.2 引入支持包</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.apache.poi<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>poi-ooxml<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    <span style="color:#f92672">&lt;version&gt;</span>3.9<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#75715e">&lt;!-- MyBatis --&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.mybatis.spring.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    <span style="color:#f92672">&lt;version&gt;</span>1.3.1<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span><span style="color:#75715e">&lt;!-- Spring Batch --&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-batch<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>    <span style="color:#f92672">&lt;version&gt;</span>${springboot.version}<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h2 id="33-fetchsize">3.3 FetchSize</h2>
<p>另一个要改的地方是MyBatis的Mapper文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>  <span style="color:#f92672">&lt;select</span> <span style="color:#75af00">id=</span><span style="color:#d88200">&#34;exportByExample&#34;</span> <span style="color:#75af00">fetchSize=</span><span style="color:#d88200">&#34;-2147483648&#34;</span> <span style="color:#75af00">parameterType=</span><span style="color:#d88200">&#34;com.eveus.admin.po.logs.BankcardAuthNoOTPLogPOExample&#34;</span> <span style="color:#75af00">resultSetType=</span><span style="color:#d88200">&#34;FORWARD_ONLY&#34;</span> <span style="color:#75af00">resultMap=</span><span style="color:#d88200">&#34;BaseResultMap&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    select
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    <span style="color:#f92672">&lt;include</span> <span style="color:#75af00">refid=</span><span style="color:#d88200">&#34;Export_Column_List&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    from UID_BANKCARD_AUTH_NO_OTP_LOG 
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    <span style="color:#f92672">&lt;if</span> <span style="color:#75af00">test=</span><span style="color:#d88200">&#34;_parameter != null&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>      <span style="color:#f92672">&lt;include</span> <span style="color:#75af00">refid=</span><span style="color:#d88200">&#34;Example_Where_Clause&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    <span style="color:#f92672">&lt;/if&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    <span style="color:#f92672">&lt;if</span> <span style="color:#75af00">test=</span><span style="color:#d88200">&#34;orderByClause != null&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>      order by ${orderByClause}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    <span style="color:#f92672">&lt;/if&gt;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>  <span style="color:#f92672">&lt;/select&gt;</span>
</span></span></code></pre></div><p>注意其中的<code>fetchSize</code>是新增的，其值必须为<code>-2147483648</code>（至于为什么，将在下一篇文章中介绍）。另外，还新增了配置项<code>resultSetType</code>，其值为：<code>FORWARD_ONLY</code>。</p>
<h2 id="34-导出过程改造">3.4 导出过程改造</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#75715e">// 使用游标获取数据（避免结果集太大引起的OOM错误）
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#75715e"></span><span style="color:#111">MyBatisCursorItemReader</span><span style="color:#f92672">&lt;</span><span style="color:#111">MatchCompanyLogPO</span><span style="color:#f92672">&gt;</span> <span style="color:#111">reader</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">MyBatisCursorItemReader</span><span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#111">reader</span><span style="color:#f92672">.</span><span style="color:#75af00">setSqlSessionFactory</span><span style="color:#f92672">(</span><span style="color:#111">sqlSessionFactory</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#111">reader</span><span style="color:#f92672">.</span><span style="color:#75af00">setQueryId</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;com.eveus.admin.mapper.logs.MatchCompanyLogPOCustMapper.exportByExample&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="color:#111">Map</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">,</span> <span style="color:#111">Object</span><span style="color:#f92672">&gt;</span> <span style="color:#111">readerParams</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HashMap</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">,</span> <span style="color:#111">Object</span><span style="color:#f92672">&gt;();</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span><span style="color:#111">readerParams</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;oredCriteria&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">example</span><span style="color:#f92672">.</span><span style="color:#75af00">getOredCriteria</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#75715e">// 设置参数
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span><span style="color:#75715e"></span><span style="color:#111">reader</span><span style="color:#f92672">.</span><span style="color:#75af00">setParameterValues</span><span style="color:#f92672">(</span><span style="color:#111">readerParams</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#00a8c8">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>    <span style="color:#111">reader</span><span style="color:#f92672">.</span><span style="color:#75af00">open</span><span style="color:#f92672">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">ExecutionContext</span><span style="color:#f92672">());</span>    <span style="color:#75715e">// 打开游标
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span><span style="color:#75715e"></span>    <span style="color:#111">MatchCompanyLogPO</span> <span style="color:#111">logPO</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    <span style="color:#00a8c8">while</span> <span style="color:#f92672">((</span> <span style="color:#111">logPO</span> <span style="color:#f92672">=</span> <span style="color:#111">reader</span><span style="color:#f92672">.</span><span style="color:#75af00">read</span><span style="color:#f92672">())</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>        <span style="color:#75715e">// 写入Excel文件
</span></span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span><span style="color:#75715e"></span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>    <span style="color:#111">logger</span><span style="color:#f92672">.</span><span style="color:#75af00">info</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;exportMatchCompany：文件名{}，共{}条&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">fileName</span><span style="color:#f92672">,</span> <span style="color:#111">exporter</span><span style="color:#f92672">.</span><span style="color:#75af00">getNumberOfRows</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>    <span style="color:#111">logger</span><span style="color:#f92672">.</span><span style="color:#75af00">info</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;exportMatchCompany: Open Cursor: {}, Read all records: {}&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">d2</span><span style="color:#f92672">.</span><span style="color:#75af00">getTime</span><span style="color:#f92672">()-</span><span style="color:#111">d1</span><span style="color:#f92672">.</span><span style="color:#75af00">getTime</span><span style="color:#f92672">(),</span> <span style="color:#111">d3</span><span style="color:#f92672">.</span><span style="color:#75af00">getTime</span><span style="color:#f92672">()-</span><span style="color:#111">d2</span><span style="color:#f92672">.</span><span style="color:#75af00">getTime</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>    <span style="color:#111">ResponseWriteUtil</span><span style="color:#f92672">.</span><span style="color:#75af00">writeFileStream</span><span style="color:#f92672">(</span><span style="color:#111">exporter</span><span style="color:#f92672">.</span><span style="color:#75af00">getWorkbook</span><span style="color:#f92672">(),</span> <span style="color:#111">fileName</span><span style="color:#f92672">,</span> <span style="color:#111">response</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span><span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">Exception</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>    <span style="color:#111">logger</span><span style="color:#f92672">.</span><span style="color:#75af00">error</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;exportMatchCompany exception! &#34;</span><span style="color:#f92672">,</span> <span style="color:#111">e</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h1 id="4-补充">4. 补充</h1>
<p>改造的代码不多，但是整个探索的时间确实不少。这可能就是重构的魅力吧。</p>
<p>另外，在导出过程中还发现了一个有趣的事情：最开始导出Excel的时候，发现最多只能导出<code>1048576</code>条记录。最初甚至怀疑是不是数据库方面有什么限制。到最后才发现原来是Excel本身的限制：Excel中一个Sheet最多支持1048576条记录，行号范围为0-1048575。</p>
<h1 id="附录参考资料">附录、参考资料</h1>
<ul>
<li><a href="https://stackoverflow.com/questions/23734004/invalid-row-number-32768-outside-allowable-range-0-1048575">Invalid row number (-32768) outside allowable range (0..1048575)</a></li>
<li><a href="https://blog.csdn.net/w405722907/article/details/77155630">POI操作Excel时最大行、列数的问题及写大量数据时Java heap space内存溢出解决</a></li>
<li><a href="http://www.mybatis.org/mybatis-3/sqlmap-xml.html">Mapper XML Files</a></li>
<li><a href="https://www.jianshu.com/p/97d96201295b">Mybatis 3.4.0 Cursor的使用</a></li>
<li><a href="https://www.jianshu.com/p/c4b194b269c1">使用MySQL Server Side Cursor解决查询数据量过大造成OOM</a></li>
<li><a href="https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-reference-implementation-notes.html">JDBC API Implementation Notes</a></li>
<li><a href="https://www.jianshu.com/p/0339c6fe8b61">MyBatis中使用流式查询避免数据量过大导致OOM</a></li>
<li><a href="http://www.php-master.com/post/268274.html">Mysql中使用流式查询避免数据量过大导致OOM-后续</a></li>
<li><a href="http://www.demoso.net/taview/23913">Mybatis 3.4.0 Cursor的使用</a></li>
</ul>
    </div>
    <footer class="post-footer">
     
 
<div class="post-tags">     
     
    <a href="https://orchidflower.github.io/tags/Spring" rel="tag" title="Spring">#Spring#</a>
    
    <a href="https://orchidflower.github.io/tags/POI" rel="tag" title="POI">#POI#</a>
    
    <a href="https://orchidflower.github.io/tags/%E5%AF%BC%E5%87%BAExcel" rel="tag" title="导出Excel">#导出Excel#</a>
    
</div>



     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="https://orchidflower.github.io/2018/06/15/Solving-OutOfMemoryException-Happened-when-Exporting-Excel-using-POI-in-Spring-Part2/" rel="next" title="Spring使用POI导出Excel内存溢出问题的解决（续）">
        <i class="fa fa-chevron-left"></i> Spring使用POI导出Excel内存溢出问题的解决（续）
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="https://orchidflower.github.io/2018/06/01/migrating-to-spring-boot-05-transaction-management/" rel="prev" title="迁移到SpringBoot 05 - 事务管理">
        迁移到SpringBoot 05 - 事务管理 <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>
      
     
     
     



<div id="vcomments"></div>
    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

  <ul class="sidebar-nav motion-element">
    <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
      文章目录
    </li>
    <li class="sidebar-nav-overview" data-target="site-overview">
      站点概览
    </li>
  </ul>

    <section class="site-overview sidebar-panel ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="https://orchidflower.github.io/img/author.jpg"
        alt="Orchidflower" />
    <p class="site-author-name" itemprop="name">Orchidflower</p>
    <p class="site-description motion-element" itemprop="description"> 
        Do one thing at a time, and do well.</p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="https://orchidflower.github.io/post/">
        <span class="site-state-item-count">75</span>
        <span class="site-state-item-name">日志</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="https://orchidflower.github.io/categories/">      
         
        <span class="site-state-item-count">6</span>
        
        <span class="site-state-item-name">分类</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="https://orchidflower.github.io/tags/">
         
        <span class="site-state-item-count">82</span>
        
        <span class="site-state-item-name">标签</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://orchidflower.github.io" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
        <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/orchid-flower" target="_blank" title="知乎">
            <i class="fa fa-fw fa-globe"></i>
            知乎
        </a>
        </span>
    
        <span class="links-of-author-item">
        <a href="https://orchidflower.gitee.io" target="_blank" title="OSC">
            <i class="fa fa-fw fa-git"></i>
            OSC
        </a>
        </span>
    
        <span class="links-of-author-item">
        <a href="https://www.douban.com/people/47742465/" target="_blank" title="豆瓣">
            <i class="fa fa-fw fa-globe"></i>
            豆瓣
        </a>
        </span>
    
</div>


      

      
    </section>
    
<section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
    <div class="post-toc">
        <div class="post-toc-content"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-poi项目简介">1. POI项目简介</a>
      <ul>
        <li><a href="#11-excel相关">1.1 Excel相关</a></li>
      </ul>
    </li>
    <li><a href="#2-excel导出">2. Excel导出</a></li>
    <li><a href="#3-使用数据库游标">3. 使用数据库游标</a>
      <ul>
        <li><a href="#31-数据库游标">3.1 数据库游标</a></li>
        <li><a href="#32-引入支持包">3.2 引入支持包</a></li>
        <li><a href="#33-fetchsize">3.3 FetchSize</a></li>
        <li><a href="#34-导出过程改造">3.4 导出过程改造</a></li>
      </ul>
    </li>
    <li><a href="#4-补充">4. 补充</a></li>
    <li><a href="#附录参考资料">附录、参考资料</a></li>
  </ul>
</nav></div>
    </div>
</section>

  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span itemprop="copyrightYear">  &copy; 
  2009 - 2022</span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="author" itemprop="copyrightHolder">执子之手</span>
</div>
<div class="powered-by">
  Powered by - <a class="theme-link" href="http://gohugo.io" target="_blank" title="hugo" >Hugo v0.104.3</a>
</div>
<div class="powered-by">
  Theme by - <a class="theme-link" href="https://github.com/xtfly/hugo-theme-next" target="_blank"> NexT
  </a>
</div>
<div class="theme-info">
  ICP - <a href="https://beian.miit.gov.cn/" target="_blank">鲁ICP备17006463号-1</a>
</div>


      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
<script type="text/javascript" src="https://orchidflower.github.io/js/vendor/jquery/index.js?v=2.1.3"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/vendor/fastclick/lib/fastclick.min.js?v=1.0.6"></script> 
<script type="text/javascript" src="https://orchidflower.github.io/js/vendor/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/vendor/velocity/velocity.min.js?v=1.2.1"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/vendor/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="https://orchidflower.github.io/js/vendor/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>

<script src="https://orchidflower.github.io/js/vendor/fancybox/jquery.fancybox.pack.js?v=2.1.5"></script>

<script type="text/javascript" src="https://orchidflower.github.io/js/utils.js"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/motion.js"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/affix.js"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/schemes/pisces.js"></script>

<script type="text/javascript" src="https://orchidflower.github.io/js/scrollspy.js"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/post-details.js"></script>
<script type="text/javascript" src="https://orchidflower.github.io/js/toc.js"></script>

<script type="text/javascript" src="https://orchidflower.github.io/js/bootstrap.js"></script>

<script type="text/javascript" src="https://orchidflower.github.io/js/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      displayMath: [ ['$$','$$'] ],
      processEscapes: true
    },
    "HTML-CSS": { fonts: ["TeX"] }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>
<script src="https://orchidflower.github.io/js/vendor/valine/av-min.js"></script>
<script src="https://orchidflower.github.io/js/vendor/valine/Valine.min.js"></script>

<script>
  new Valine({
    el: '#vcomments',
    appId: 'rRoK18jJcvpFfn8Qmjmr0U5Y-MdYXbMMI',
    appKey: '0VSzBkok3Snp1c4xHL4r3Sn3',
    serverURLs: 'https:\/\/leancloud-api.orchidflower.cn',
    visitor: true,
    placeholder: 'Leave a comment...',
    recordIP: true
  })
</script>

</body>
</html>